---
- name: Fail if docker_image is not provided
  fail:
    msg: "docker_image variable must be provided (example: ghcr.io/org/app:latest)"
  when: docker_image is not defined

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0755"

# ----------------------------
# SSH Hardening
# ----------------------------
- name: Disable root SSH login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
  notify: restart ssh

- name: Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
  notify: restart ssh

- name: Apply SSH changes safely
  meta: flush_handlers

# ----------------------------
# Application Deployment
# ----------------------------
- name: Copy docker-compose file
  copy:
    src: docker-compose.yml
    dest: "{{ app_dir }}/docker-compose.yml"
    owner: ubuntu
    group: ubuntu
    mode: "0644"

- name: Create .env file
  copy:
    dest: "{{ app_dir }}/.env"
    content: |
      IMAGE={{ docker_image }}
    owner: ubuntu
    group: ubuntu
    mode: "0600"

- name: Validate docker-compose file
  command: docker compose config
  args:
    chdir: "{{ app_dir }}"
  become_user: ubuntu

- name: Stop existing containers (safe)
  command: docker compose down
  args:
    chdir: "{{ app_dir }}"
  become_user: ubuntu
  ignore_errors: true

- name: Pull Docker images
  command: docker compose pull
  args:
    chdir: "{{ app_dir }}"
  become_user: ubuntu

- name: Start application via docker-compose
  command: docker compose up -d --remove-orphans
  args:
    chdir: "{{ app_dir }}"
  become_user: ubuntu

- name: Wait for containers to initialize
  pause:
    seconds: 5

# ----------------------------
# Post-deploy Health Check
# ----------------------------
- name: Wait for application to become healthy
  uri:
    url: "http://localhost"
    status_code: 200
    timeout: 5
  register: healthcheck
  retries: 10
  delay: 5
  until: healthcheck.status == 200
